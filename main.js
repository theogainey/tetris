"use strict";(()=>{function x(){let e=["I","J","L","O","S","T","Z"],o=Math.floor(Math.random()*e.length);return e[o]}function v(e){return e==="I"||e==="O"}function d(){let e=y.next;return y.next=x(),{typeCurrent:e,typeNext:y.next,xCurrent:v(e)?5:4.5,yCurrent:v(e)?-2:-1.5}}var p=30,h=48,s={I:{position1:[[-2,-1],[-1,-1],[0,-1],[1,-1]],position2:[[0,-2],[0,-1],[0,0],[0,1]]},J:{position1:[[-1.5,-1.5],[-1.5,-.5],[-.5,-.5],[.5,-.5]],position2:[[-.5,-1.5],[.5,-1.5],[-.5,-.5],[-.5,.5]],position3:[[-1.5,-.5],[-.5,-.5],[.5,-.5],[.5,.5]],position4:[[-.5,-1.5],[-.5,-.5],[-.5,.5],[-1.5,.5]]},L:{position1:[[-1.5,-.5],[-.5,-.5],[.5,-.5],[.5,-1.5]],position2:[[-.5,-1.5],[-.5,-.5],[-.5,.5],[.5,.5]],position3:[[-1.5,-.5],[-1.5,.5],[-.5,-.5],[.5,-.5]],position4:[[-1.5,-1.5],[-.5,-1.5],[-.5,-.5],[-.5,.5]]},O:{position1:[[-1,-1],[0,-1],[-1,0],[0,0]]},S:{position1:[[-1.5,-.5],[-.5,-.5],[-.5,-1.5],[.5,-1.5]],position2:[[-.5,-1.5],[-.5,-.5],[.5,-.5],[.5,.5]]},T:{position1:[[-1.5,-.5],[-.5,-.5],[-.5,-1.5],[.5,-.5]],position2:[[-.5,-1.5],[-.5,-.5],[.5,-.5],[-.5,.5]],position3:[[-1.5,-.5],[-.5,-.5],[.5,-.5],[-.5,.5]],position4:[[-1.5,-.5],[-.5,-1.5],[-.5,-.5],[-.5,.5]]},Z:{position1:[[-1.5,-1.5],[-.5,-1.5],[-.5,-.5],[.5,-.5]],position2:[[-.5,-.5],[-.5,.5],[.5,-.5],[.5,-1.5]]}},f={I:{color:"#22d3ee",offsets:[s.I.position1,s.I.position2]},J:{color:"#818cf8",offsets:[s.J.position1,s.J.position2,s.J.position3,s.J.position4]},L:{color:"#fb923c",offsets:[s.L.position1,s.L.position2,s.L.position3,s.L.position4]},O:{color:"#facc15",offsets:[s.O.position1]},S:{color:"#4ade80",offsets:[s.S.position1,s.S.position2]},T:{color:"#c084fc",offsets:[s.T.position1,s.T.position2,s.T.position3,s.T.position4]},Z:{color:"#fb7185",offsets:[s.Z.position1,s.Z.position2]}},m=document.getElementById("playArea"),y={next:x()},t={...d(),rotation:0,framesTillDrop:h,lockedCells:[],lockDelayFrame:-1};function D(){let o=f[t.typeCurrent].offsets[t.rotation];return o.every(([n,i])=>i+t.yCurrent<19)?o.every(([n,i])=>t.lockedCells.filter(({xStart:r})=>r===n+t.xCurrent).every(({yStart:r})=>i+t.yCurrent+1!==r)):!1}function O(){let n=f[t.typeCurrent].offsets[t.rotation].map(([r,c])=>c+t.yCurrent),i=[...new Set(n)],l=[];i.forEach(r=>{t.lockedCells.filter(({yStart:C})=>C===r).length===10&&(t.lockedCells=t.lockedCells.filter(({yStart:C})=>C!==r),l.push(r))}),t.lockedCells=t.lockedCells.map(r=>{let c=l.filter(C=>C>r.yStart);return{...r,yStart:r.yStart+c.length}})}function T(){if(D()){if(t.framesTillDrop>0&&t.lockDelayFrame===-1){t.framesTillDrop=t.framesTillDrop-1;return}if(t.lockDelayFrame===-1){t.framesTillDrop=h,t.yCurrent=t.yCurrent+1;return}}if(t.lockDelayFrame===-1){t.lockDelayFrame=0;return}if(t.lockDelayFrame<30){t.lockDelayFrame++;return}if(t.lockDelayFrame=-1,D())return;f[t.typeCurrent].offsets[t.rotation].forEach(([o,n])=>{t.lockedCells.push({color:f[t.typeCurrent].color,xStart:t.xCurrent+o,yStart:t.yCurrent+n})}),O();let e=d();t.xCurrent=e.xCurrent,t.yCurrent=e.yCurrent,t.typeCurrent=e.typeCurrent,t.typeNext=e.typeNext,t.rotation=0}function w(e,o,n,i){let l=n*p,r=i*p;e.fillStyle=o,e.fillRect(l,r,p,p),e.strokeRect(l,r,p,p),e.shadowBlur=20,e.shadowColor="#323232",e.fillRect(l+5,r+5,p-10,p-10),e.shadowBlur=0}function E(e,o,n,i){o.offsets[t.rotation].forEach(([l,r])=>{w(e,o.color,n+l,i+r)})}function I(){let o=document.getElementById("next").getContext("2d"),n=f[t.typeNext],i=t.typeNext==="O"?1.5:2;o.clearRect(0,0,m.width,m.height),n.offsets[0].forEach(([l,r])=>{w(o,f[t.typeNext].color,2.5+l,i+r)})}function k(){let e=m.getContext("2d");e.clearRect(0,0,m.width,m.height),E(e,f[t.typeCurrent],t.xCurrent,t.yCurrent),I(),t.lockedCells.forEach(({color:o,xStart:n,yStart:i})=>{w(e,o,n,i)})}function S(e){return A(e)&&N(e)}function N(e){if(e<0)return!1;let{offsets:o}=f[t.typeCurrent];return o[t.rotation].every(([i,l])=>t.lockedCells.filter(({xStart:c})=>c===e+i).every(({yStart:c})=>l+t.yCurrent!==c))}function A(e){return f[t.typeCurrent].offsets[t.rotation].every(([o])=>o+e<=9&&o+e>=0)}function J(){let{offsets:e}=f[t.typeCurrent],o=e[t.rotation].map(([a,u])=>u+t.yCurrent),n=e[t.rotation].map(([a,u])=>a+t.xCurrent),i=Math.max(...o),l=t.lockedCells.filter(({xStart:a,yStart:u})=>n.includes(a)&&u>i);if(l.length===0){let u=o.find(b=>b===i)-t.yCurrent;t.yCurrent=19-u;return}let r=Math.min(...l.map(({yStart:a})=>a)),C=l.filter(({yStart:a})=>a===r).map(({xStart:a})=>a),F=e[t.rotation].filter(([a,u])=>C.includes(a+t.xCurrent)),L=Math.max(...F.map(([a,u])=>u));t.yCurrent=r-1-L}function g(){window.addEventListener("keydown",e=>{switch(e.key){case"ArrowRight":S(t.xCurrent+1)&&(t.xCurrent=t.xCurrent+1);return;case"ArrowLeft":S(t.xCurrent-1)&&(t.xCurrent=t.xCurrent-1);return;case"ArrowUp":let o=t.rotation,n=t.rotation+1;n===f[t.typeCurrent].offsets.length&&(n=0),t.rotation=n,S(t.xCurrent)||(t.rotation=o);return;case"ArrowDown":t.framesTillDrop=t.framesTillDrop-48;return;case" ":J();return;default:return}})}function R(){window.requestAnimationFrame(R),T(),k()}g();R();})();
