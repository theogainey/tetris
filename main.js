"use strict";(()=>{function h(){let t=["I","J","L","O","S","T","Z"],o=Math.floor(Math.random()*t.length);return t[o]}function v(t){return t==="I"||t==="O"}function D(t){let{score:o,level:r}=e;if(t===1){e.score=o+r*40;return}if(t===2){e.score=o+r*100;return}if(t===3){e.score=o+r*300;return}if(t===4){e.score=o+r*1200;return}}function y(){let t=d.next;return d.next=h(),{typeCurrent:t,typeNext:d.next,xCurrent:v(t)?5:4.5,yCurrent:v(t)?-2:-1.5}}var p=30,x=[48,43,38,33,28,23,18,13,8,6,5,4,3,2,1],i={I:{position1:[[-2,-1],[-1,-1],[0,-1],[1,-1]],position2:[[0,-2],[0,-1],[0,0],[0,1]]},J:{position1:[[-1.5,-1.5],[-1.5,-.5],[-.5,-.5],[.5,-.5]],position2:[[-.5,-1.5],[.5,-1.5],[-.5,-.5],[-.5,.5]],position3:[[-1.5,-.5],[-.5,-.5],[.5,-.5],[.5,.5]],position4:[[-.5,-1.5],[-.5,-.5],[-.5,.5],[-1.5,.5]]},L:{position1:[[-1.5,-.5],[-.5,-.5],[.5,-.5],[.5,-1.5]],position2:[[-.5,-1.5],[-.5,-.5],[-.5,.5],[.5,.5]],position3:[[-1.5,-.5],[-1.5,.5],[-.5,-.5],[.5,-.5]],position4:[[-1.5,-1.5],[-.5,-1.5],[-.5,-.5],[-.5,.5]]},O:{position1:[[-1,-1],[0,-1],[-1,0],[0,0]]},S:{position1:[[-1.5,-.5],[-.5,-.5],[-.5,-1.5],[.5,-1.5]],position2:[[-.5,-1.5],[-.5,-.5],[.5,-.5],[.5,.5]]},T:{position1:[[-1.5,-.5],[-.5,-.5],[-.5,-1.5],[.5,-.5]],position2:[[-.5,-1.5],[-.5,-.5],[.5,-.5],[-.5,.5]],position3:[[-1.5,-.5],[-.5,-.5],[.5,-.5],[-.5,.5]],position4:[[-1.5,-.5],[-.5,-1.5],[-.5,-.5],[-.5,.5]]},Z:{position1:[[-1.5,-1.5],[-.5,-1.5],[-.5,-.5],[.5,-.5]],position2:[[-.5,-.5],[-.5,.5],[.5,-.5],[.5,-1.5]]}},c={I:{color:"#22d3ee",offsets:[i.I.position1,i.I.position2]},J:{color:"#818cf8",offsets:[i.J.position1,i.J.position2,i.J.position3,i.J.position4]},L:{color:"#fb923c",offsets:[i.L.position1,i.L.position2,i.L.position3,i.L.position4]},O:{color:"#facc15",offsets:[i.O.position1]},S:{color:"#4ade80",offsets:[i.S.position1,i.S.position2]},T:{color:"#c084fc",offsets:[i.T.position1,i.T.position2,i.T.position3,i.T.position4]},Z:{color:"#fb7185",offsets:[i.Z.position1,i.Z.position2]}},C=document.getElementById("playArea"),d={next:h()},e={...y(),rotation:0,linesCleared:0,level:1,score:0,framesTillDrop:x[0],lockedCells:[],lockDelayFrame:-1};function E(){let o=c[e.typeCurrent].offsets[e.rotation];return o.every(([r,l])=>l+e.yCurrent<19)?o.every(([r,l])=>e.lockedCells.filter(({xStart:n})=>n===r+e.xCurrent).every(({yStart:n})=>l+e.yCurrent+1!==n)):!1}function b(){let r=c[e.typeCurrent].offsets[e.rotation].map(([n,f])=>f+e.yCurrent),l=[...new Set(r)],s=[];l.forEach(n=>{e.lockedCells.filter(({yStart:m})=>m===n).length===10&&(e.lockedCells=e.lockedCells.filter(({yStart:m})=>m!==n),s.push(n))}),e.lockedCells=e.lockedCells.map(n=>{let f=s.filter(m=>m>n.yStart);return{...n,yStart:n.yStart+f.length}}),D(s.length),e.linesCleared+=s.length,console.log(e.linesCleared,e.level)}function T(){if(E()){if(e.framesTillDrop>0&&e.lockDelayFrame===-1){e.framesTillDrop=e.framesTillDrop-1;return}if(e.lockDelayFrame===-1){e.framesTillDrop=x[e.level-1],e.yCurrent=e.yCurrent+1;return}}if(e.lockDelayFrame===-1){e.lockDelayFrame=0;return}if(e.lockDelayFrame<30){e.lockDelayFrame++;return}if(e.lockDelayFrame=-1,E())return;c[e.typeCurrent].offsets[e.rotation].forEach(([o,r])=>{e.lockedCells.push({color:c[e.typeCurrent].color,xStart:e.xCurrent+o,yStart:e.yCurrent+r})}),b();let t=y();e.xCurrent=t.xCurrent,e.yCurrent=t.yCurrent,e.typeCurrent=t.typeCurrent,e.typeNext=t.typeNext,e.rotation=0,e.level=Math.ceil((e.linesCleared+1)/10),e.framesTillDrop=x[e.level-1]}function S(t,o,r,l){let s=r*p,n=l*p;t.fillStyle=o,t.fillRect(s,n,p,p),t.strokeRect(s,n,p,p),t.shadowBlur=20,t.shadowColor="#323232",t.fillRect(s+5,n+5,p-10,p-10),t.shadowBlur=0}function M(t,o,r,l){o.offsets[e.rotation].forEach(([s,n])=>{S(t,o.color,r+s,l+n)})}function O(){let o=document.getElementById("next").getContext("2d"),r=c[e.typeNext],l=e.typeNext==="O"?1.5:2;o.clearRect(0,0,C.width,C.height),r.offsets[0].forEach(([s,n])=>{S(o,c[e.typeNext].color,2.5+s,l+n)})}function H(){let t=document.getElementById("level");t.innerText=`${e.level}`;let o=document.getElementById("score");o.innerText=`${e.score}`;let r=document.getElementById("lines");r.innerText=`${e.linesCleared}`}function w(){let t=C.getContext("2d");t.clearRect(0,0,C.width,C.height),M(t,c[e.typeCurrent],e.xCurrent,e.yCurrent),O(),H(),e.lockedCells.forEach(({color:o,xStart:r,yStart:l})=>{S(t,o,r,l)})}function g(t){return N(t)&&B(t)}function B(t){if(t<0)return!1;let{offsets:o}=c[e.typeCurrent];return o[e.rotation].every(([l,s])=>e.lockedCells.filter(({xStart:f})=>f===t+l).every(({yStart:f})=>s+e.yCurrent!==f))}function N(t){return c[e.typeCurrent].offsets[e.rotation].every(([o])=>o+t<=9&&o+t>=0)}function A(){let{offsets:t}=c[e.typeCurrent],o=t[e.rotation].map(([a,u])=>u+e.yCurrent),r=t[e.rotation].map(([a,u])=>a+e.xCurrent),l=Math.max(...o),s=e.lockedCells.filter(({xStart:a,yStart:u})=>r.includes(a)&&u>l);if(s.length===0){let u=o.find(I=>I===l)-e.yCurrent;e.yCurrent=19-u;return}let n=Math.min(...s.map(({yStart:a})=>a)),m=s.filter(({yStart:a})=>a===n).map(({xStart:a})=>a),R=t[e.rotation].filter(([a,u])=>m.includes(a+e.xCurrent)),F=Math.max(...R.map(([a,u])=>u));e.yCurrent=n-1-F}function k(){window.addEventListener("keydown",t=>{switch(t.key){case"ArrowRight":g(e.xCurrent+1)&&(e.xCurrent=e.xCurrent+1);return;case"ArrowLeft":g(e.xCurrent-1)&&(e.xCurrent=e.xCurrent-1);return;case"ArrowUp":let o=e.rotation,r=e.rotation+1;r===c[e.typeCurrent].offsets.length&&(r=0),e.rotation=r,g(e.xCurrent)||(e.rotation=o);return;case"ArrowDown":e.framesTillDrop=e.framesTillDrop-48;return;case" ":A();return;default:return}})}function L(){window.requestAnimationFrame(L),T(),w()}k();L();})();
